<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bouncing Clock Screensaver</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    width: 100%;
    height: 100%;
    font-family: Arial, sans-serif;
    /* Smooth fade for background & color */
    transition: background 1s ease, color 1s ease;
  }
  #clock {
    position: absolute;
    text-align: center;
    white-space: nowrap;
    /* Smooth fade for text opacity too */
    transition: opacity 1s ease;
  }
  #time {
    font-size: 4em;
    font-weight: bold;
  }
  #date {
    font-size: 1.5em;
    opacity: 0.8;
  }
</style>
</head>
<body>

<div id="clock">
  <div id="time"></div>
  <div id="date"></div>
</div>

<script>
  const clock = document.getElementById("clock");
  const timeElem = document.getElementById("time");
  const dateElem = document.getElementById("date");

  let sunrise = null;
  let sunset = null;
  let currentMode = null; // 'day' or 'night'

  // --- Sunrise/Sunset Calculator ---
  function getSunTimes(date, lat, lng) {
    const rad = Math.PI / 180;
    const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
    const lngHour = lng / 15;

    function calcTime(isSunrise) {
      const t = dayOfYear + ((isSunrise ? 6 : 18) - lngHour) / 24;
      const M = (0.9856 * t) - 3.289;
      let L = M + (1.916 * Math.sin(rad * M)) + (0.020 * Math.sin(2 * rad * M)) + 282.634;
      L = (L + 360) % 360;
      let RA = Math.atan(0.91764 * Math.tan(rad * L)) / rad;
      RA = (RA + 360) % 360;
      const Lquadrant  = Math.floor(L/90) * 90;
      const RAquadrant = Math.floor(RA/90) * 90;
      RA = RA + (Lquadrant - RAquadrant);
      RA /= 15;

      const sinDec = 0.39782 * Math.sin(rad * L);
      const cosDec = Math.cos(Math.asin(sinDec));
      const cosH = (Math.cos(rad * 90.833) - (sinDec * Math.sin(rad * lat))) / (cosDec * Math.cos(rad * lat));

      if (cosH > 1 && isSunrise) return null; // Sun never rises
      if (cosH < -1 && !isSunrise) return null; // Sun never sets

      let H = isSunrise ? (360 - Math.acos(cosH) / rad) : (Math.acos(cosH) / rad);
      H /= 15;

      const T = H + RA - (0.06571 * t) - 6.622;
      let UT = (T - lngHour) % 24;
      if (UT < 0) UT += 24;

      const localTime = new Date(date);
      localTime.setUTCHours(0, 0, 0, 0);
      localTime.setHours(Math.floor(UT), Math.floor((UT % 1) * 60), 0, 0);
      return localTime;
    }

    return {
      sunrise: calcTime(true),
      sunset: calcTime(false)
    };
  }

  // Update time + date & switch theme if needed
  function updateClock() {
    const now = new Date();

    // Format time
    const time = now.toLocaleTimeString('en-US', { hour12: true });

    // Format date like "Sunday, July 27 2025"
    const day = now.toLocaleDateString('en-US', { weekday: 'long' });
    const dateString = now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

    timeElem.textContent = time;
    dateElem.textContent = `${day}, ${dateString}`;

    if (sunrise && sunset) {
      let newMode = (now >= sunrise && now < sunset) ? "day" : "night";

      if (newMode !== currentMode) {
        currentMode = newMode;

        // Fade text out before switching background
        clock.style.opacity = "0";

        setTimeout(() => {
          if (newMode === "day") {
            document.body.style.background = "white";
            document.body.style.color = "black";
          } else {
            document.body.style.background = "black";
            document.body.style.color = "white";
          }
          // Fade text back in after background change
          clock.style.opacity = "1";
        }, 500); // Halfway through the transition
      }
    }
  }

  setInterval(updateClock, 1000);

  // Bounce logic
  let x = 100, y = 100;
  let dx = 2, dy = 2;

  function bounce() {
    const rect = clock.getBoundingClientRect();
    const width = window.innerWidth;
    const height = window.innerHeight;

    x += dx;
    y += dy;

    if (x + rect.width >= width || x <= 0) dx = -dx;
    if (y + rect.height >= height || y <= 0) dy = -dy;

    clock.style.left = x + "px";
    clock.style.top = y + "px";

    requestAnimationFrame(bounce);
  }

  bounce();

  // Detect location ONCE and calculate sunrise/sunset
  function setupSunTimes(lat, lon) {
    const today = new Date();
    const sunTimes = getSunTimes(today, lat, lon);
    sunrise = sunTimes.sunrise;
    sunset = sunTimes.sunset;
    console.log("Sunrise:", sunrise, "Sunset:", sunset);

    // Force an initial check so background is correct right away
    updateClock();
  }

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      setupSunTimes(pos.coords.latitude, pos.coords.longitude);
    }, () => {
      console.warn("No location → default night mode");
      document.body.style.background = "black";
      document.body.style.color = "white";
    });
  } else {
    console.warn("Geolocation not supported → default night mode");
    document.body.style.background = "black";
    document.body.style.color = "white";
  }

  // Adjust when window resizes
  window.addEventListener("resize", () => {
    x = Math.min(x, window.innerWidth - clock.offsetWidth);
    y = Math.min(y, window.innerHeight - clock.offsetHeight);
  });
</script>

</body>
</html>
